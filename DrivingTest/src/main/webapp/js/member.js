define("jkbd!app/home/member",["jkbd!widgets/Dialog"],function(e){var t=this.Simple,n=t.Core.Utils,s=(t.Core.Store,t.Core.Template),a=(t.Core.Cookie,t.UserApi),i=t.AuthApi,o=function(e,t){t=t||"",e&&e.html(t);var s={isWorkIng:!1,isStop:!1,rules:{tel:function(e){if(!e)return"\u8bf7\u8f93\u5165\u624b\u673a\u53f7";var t=!(!e||!e.match(/^1\d{10}$/));return t?void 0:"\u624b\u673a\u53f7\u683c\u5f0f\u9519\u8bef"},psw:function(e){if(!e)return"\u8bf7\u8f93\u5165\u5bc6\u7801";var t=!!(e&&e.length>=6);return t?e.length>20?"\u5bc6\u7801\u4e0d\u80fd\u8d85\u8fc720\u4f4d\u6570":void 0:"\u5bc6\u7801\u81f3\u5c11\u4e3a6\u4f4d\u6570"},psw2:function(e){return e?e!=$(".psw").val()?"\u4e24\u6b21\u5bc6\u7801\u4e0d\u4e00\u81f4":void 0:"\u8bf7\u518d\u6b21\u8f93\u5165\u5bc6\u7801"},smsCode:function(e){if(!e)return"\u8bf7\u8f93\u5165\u77ed\u4fe1\u9a8c\u8bc1\u7801";var t=!!(e&&e.length>=4);return t?void 0:"\u9a8c\u8bc1\u7801\u683c\u5f0f\u9519\u8bef"},captchaCode:function(e){if(!e)return"\u8bf7\u8f93\u5165\u56fe\u7247\u9a8c\u8bc1\u7801";var t=!!(e&&e.length>=4);return t?void 0:"\u9a8c\u8bc1\u7801\u683c\u5f0f\u9519\u8bef"}},showError:function(t){e.addClass("error").html(t)},checkItem:function(n,a){var i=s.rules[n],o=$(s.bindDom[n]),r=i?i(o.val()):"";a&&(r=a);var c=o.parents(".input-d");return r?(e?(c.find("label").remove(),s.showError(r)):c.find("label").html(r),c.addClass("error"),!1):(e&&e.removeClass("error").html(t),c.removeClass("error"),!0)},bindDom:function(e){return s.isWorkIng=!0,s.check.keyList=[],n.each(e,function(e,t){e.blur(function(){s.isWorkIng&&(s.isStop||s.check.keyList.indexOf(t)>-1&&s.checkItem(t))}),s.bindDom[t]=e}),s},unBind:function(){s.isWorkIng=!1,s.check.keyList=[],n.each(s.bindDom,function(e,t){delete s.bindDom[t]})},stop:function(e){s.isStop=!!e},check:function(e){var t=e.split(",");s.check.keyList=t;for(var n=0;n<t.length;n++)if(s.checkItem(t[n])===!1)return!1;return!0}};return s},r=function(t){if(!r.isShow){r.isShow=!0,i.User.logout();var n=function(){var e="<span class='user-span ellipsis fl'><a rel='nofollow' href='/my/'>"+i.User.userInfo.nickname+"</a></span><span class='logout-btn fl' data-action='logout'>\u9000\u51fa</span>";$(".jkbd-main-header-top .auth-info").html(e)},a=function(e){var s=this,a=e.find(".submit"),r=!1,c=o($(".tips-d .tips"),"\u6ce8\u518c/\u767b\u5f55\u540e\u53ef\u4fdd\u5b58\u505a\u9898\u8fdb\u5ea6");c.bindDom({tel:e.find("[name=tel]"),psw:e.find("[name=psw]")});var d=function(){if(n(),window.localStorage)try{window.localStorage.removeItem("jkbd_showTipsSync"),window.localStorage.setItem("jkbd_showTipsSync",1)}catch(e){}t?t():window.location.reload()};$(".login-form").submit(function(){return r||c.check("tel,psw")===!1?!1:(_hmt.push(["_trackEvent","\u8d26\u53f7\u64cd\u4f5c","\u767b\u5f55\u63d0\u4ea4"]),a.attr("disabled",!0),i.phoneLogin.login({phoneNumber:e.find("[name=tel]").val(),password:e.find("[name=psw]").val()}).then(function(e,t){a.attr("disabled",!1),r=!1,e?(s.close(),d(t)):c.showError(t||"\u7528\u6237\u540d\u6216\u8005\u5bc6\u7801\u9519\u8bef")}),!1)})};e({width:400,className:"member-login-dialog",title:!1,backdrop:!0,closeBtn:!1,content:s("jkbd!member/dialogLogin",null,function(e){var t=this;$(e).find(".close-btn").click(function(){t.close(),r.isShow=!1}),a.call(t,$(".login-content"))})})}},c=function(){i.User.logout(),window.location.reload()},d=function(e,t){var n=t.$htmls[0];n in l&&l[n]($(".page-member"))},l={reg:function(t){var n,a,r=t.find(".smsBtn"),c=t.find(".submit"),d=t.find(".captchaImg"),l=function(){i.register.getCaptcha().then(function(e,t){e&&(n=t.captchaId,d.attr("src",t.captchaUrl))})};l(),d.click(l);var m=o();m.bindDom({tel:t.find(".tel"),psw:t.find(".psw"),smsCode:t.find(".smsYzm"),captchaCode:t.find(".captchaCode")}),$("input").blur(function(){var e=$(this).attr("name");-1!=["tel","psw","captchaCode"].indexOf(e)&&(m.check(e)===!1?r.addClass("disabled"):r.removeClass("disabled"))});var h;r.click(function(){if(!r.hasClass("disabled")&&(r.addClass("disabled"),m.check("tel,psw,captchaCode")!==!1)){h&&clearInterval(h);var o=function(t,n,o){if(r.removeClass("disabled"),!t){if(20009==o.code)return e.alert("\u56fe\u7247\u9a8c\u8bc1\u7801\u8d85\u65f6"),void l();if(3e4==o.code){var c=o.response.data.data.captchaId;return void e({title:"",content:s("jkbd!member/regProtect",null,null,o.response.data.data),width:350,backdrop:!0,closeBtn:!1,className:"",buttons:"\u53d6\u6d88 \u786e\u5b9a",renderAfter:function(e){var t=this;$(e).find(".protect_close").click(function(){t.close()})},click:function(t){var n=this;return 1==t?(i.protectionVerify({captchaId:c,captchaCode:$(".protect-code").val()}).then(function(t,s){t?(r.click(),n.close()):e.alert(s)}),!1):void 0}})}return e.alert(n)}a=n.smsId;var d=parseInt(n.restSeconds)||60;r.addClass("disabled").html(d+"s\u540e\u91cd\u53d1"),h=setInterval(function(){d--,0>=d?(clearInterval(h),r.removeClass("disabled").html("\u70b9\u51fb\u83b7\u53d6")):r.html(d+"s\u540e\u91cd\u53d1")},1e3)};i.register.getMessage({captchaId:n,captchaCode:t.find(".captchaCode").val(),phoneNumber:t.find(".tel").val(),password:t.find(".psw").val()}).then(o)}}),$(".reg-form").submit(function(){return a?c.hasClass("disabled")?!1:m.check("tel,psw,smsYzm,smsCode")===!1?!1:(c.addClass("disabled"),_hmt&&_hmt.push(["_trackEvent","\u8d26\u53f7\u64cd\u4f5c","\u6ce8\u518c_\u63d0\u4ea4"]),i.register.register({smsId:a,smsCode:$(".smsYzm").val()}).then(function(t,n){c.removeClass("disabled"),t?e.alert("\u6ce8\u518c\u6210\u529f",function(){window.location="/member/login.html"}):e.alert(n)}),!1):(e.alert("\u77ed\u4fe1\u9a8c\u8bc1\u7801\u65e0\u6548"),!1)})},forget:function(t){var n,s,r,c=function(e){return t.find(e)},d=c(".captchaImg"),l=c(".captchaCode"),m=c(".getSms"),h=c(".tel"),u=function(){i.password.forgot.getCaptcha().then(function(e,t){e&&(n=t.captchaId,d.attr("src",t.captchaUrl))})};u(),d.click(u);var f=o();f.bindDom({tel:c(".tel"),smsCode:c(".smsCode"),captchaCode:c(".captchaCode"),psw:c(".psw")}),$("input").blur(function(){var e=$(this).attr("name");("tel"==e||"captchaCode"==e)&&(f.check(e)===!1?m.addClass("disabled"):m.removeClass("disabled"))});var p;m.click(function(){if(!m.hasClass("disabled")&&(m.addClass("disabled"),f.check("tel,captchaCode")!==!1)){p&&clearInterval(p);var e=function(e,t){if(!e)return f.checkItem("chpYzm",t||"\u56fe\u7247\u9a8c\u8bc1\u7801\u9519\u8bef");s||(s=t.smsId);var n=parseInt(t.restSeconds)||60;m.addClass("disabled").html(n+"s\u540e\u91cd\u53d1"),p=setInterval(function(){n--,0>=n?(clearInterval(p),m.removeClass("disabled").html("\u70b9\u51fb\u83b7\u53d6")):m.html(n+"s\u540e\u91cd\u53d1")},1e3)};s?i.password.forgot.regetMessage({smsId:s}).then(e):i.password.forgot.getMessage({phoneNumber:h.val(),captchaId:n,captchaCode:l.val()}).then(e)}});var v=function(){return f.check("tel,captchaCode,smsYzm,psw")===!1?!1:s?(_hmt&&_hmt.push(["_trackEvent","\u8d26\u53f7\u64cd\u4f5c","\u627e\u56de\u5bc6\u7801_\u63d0\u4ea4"]),void i.password.forgot.verifyMessage({smsId:s,smsCode:c(".smsCode").val()}).then(function(t,n){t?(r=n.smsToken,i.password.forgot.submit({smsId:s,smsToken:r,password:c(".psw").val()}).then(function(t,n){t?e.alert("\u5bc6\u7801\u4fee\u6539\u6210\u529f",function(){window.location="/"+a.userInfo.cityPinyin+"/"}):f.checkItem("psw",n||"\u4fee\u6539\u5bc6\u7801\u5931\u8d25")})):f.checkItem("smsYzm",n||"\u77ed\u4fe1\u9a8c\u8bc1\u7801\u9519\u8bef")})):(f.checkItem("smsYzm","\u77ed\u4fe1\u9a8c\u8bc1\u7801\u9519\u8bef"),!1)};$(".see-psw").click(function(){$(this).hasClass("active")?$(this).parent().find("input").attr("type","password"):$(this).parent().find("input").attr("type","text"),$(this).toggleClass("active")}),$(".forgot-form").submit(function(){return setTimeout(v,100),!1})},login:function(){i.Third.QQ.login().then(function(n,s,a){if(n){if(s.openId&&!s.authToken)return e.alert("\u6388\u6743\u6210\u529f, \u8bf7\u7ed1\u5b9a\u624b\u673a\u5b8c\u6210\u767b\u5f55"),void l.bind(s,a);window.location="/"+t.UserApi.userInfo.cityPinyin+"/"}else console.warn(s||"\u767b\u5f55\u5931\u8d25"),window.location.reload()})},bind:function(n,s){$(".page-member-thirdlogin").hide();var a,r=$(".page-member-bind").show(),c=r.find(".getSms"),d=(r.find(".submit"),$(".tel"));s=s||{},$(".third-info-d .logo").attr("src",s.figureurl_qq_2||n.avatar),$(".third-info-d .nickname").html(s.nickname||n.nickname),$(".third-info-d").show();var l=o();l.bindDom({tel:r.find(".tel"),smsCode:r.find(".smsCode")}),$("input").blur(function(){var e=$(this).attr("name");-1!=["tel"].indexOf(e)&&(l.check(e)===!1?c.addClass("disabled"):c.removeClass("disabled"))});var m;c.click(function(){if(!c.hasClass("disabled")&&(c.addClass("disabled"),l.check("tel")!==!1)){m&&clearInterval(m);var t=function(t,n){if(c.removeClass("disabled"),!t)return e.alert(n);a=n.smsId;var s=parseInt(n.restSeconds)||60;c.addClass("disabled").html(s+"s\u540e\u91cd\u53d1"),m=setInterval(function(){s--,0>=s?(clearInterval(m),c.removeClass("disabled").html("\u70b9\u51fb\u83b7\u53d6")):c.html(s+"s\u540e\u91cd\u53d1")},1e3)};i.bindUser.getMessage({thirdParty:"qqspace",openId:n.openId,phoneNumber:d.val()}).then(t)}});var h=function(){return l.check("tel")===!1?!1:a?void i.bindUser.submit({smsId:a,smsCode:$(".smsCode").val(),thirdParty:n.thirdParty}).then(function(n,s){n?e.alert("\u624b\u673a\u7ed1\u5b9a\u6210\u529f",function(){window.location="/"+t.UserApi.userInfo.cityPinyin+"/"}):e.alert(s)}):(l.checkItem("smsYzm","\u77ed\u4fe1\u9a8c\u8bc1\u7801\u9519\u8bef"),!1)};$(".form").submit(function(){return setTimeout(h,10),!1})}};return{main:d,showLogin:r,logout:c}});